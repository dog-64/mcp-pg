#!/bin/bash

# MCP PostgreSQL Server –Ω–∞ bash + psql

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ PostgreSQL –≤ PATH
export PATH="/Applications/Postgres.app/Contents/Versions/latest/bin:$PATH"

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ psql
PSQL_PATH=$(which psql)
if [ -z "$PSQL_PATH" ]; then
    echo "–û—à–∏–±–∫–∞: psql –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ" >&2
    exit 1
fi

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ .env —Ñ–∞–π–ª–∞
load_env() {
    if [ -f .env ]; then
        # –ß–∏—Ç–∞–µ–º .env —Ñ–∞–π–ª –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        while IFS='=' read -r key value; do
            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
            [[ -z "$key" || "$key" =~ ^[[:space:]]*# ]] && continue
            
            # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –∏ –∫–∞–≤—ã—á–∫–∏
            key=$(echo "$key" | xargs)
            value=$(echo "$value" | xargs | sed 's/^["'\'']\|["'\'']$//g')
            
            # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
            export "$key"="$value"
        done < .env
    fi
}

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_env

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo "$1" >&2
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ JSON –æ—Ç–≤–µ—Ç–∞
send_response() {
    echo "$1"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ —Å —Ç–µ–∫—Å—Ç–æ–º
send_success_response() {
    local id="$1"
    local text="$2"
    cat <<EOF
{
  "jsonrpc": "2.0",
  "id": $id,
  "result": {
    "content": [
      {
        "type": "text",
        "text": "$text"
      }
    ]
  }
}
EOF
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ —Å –æ—à–∏–±–∫–æ–π
send_error_response() {
    local id="$1"
    local error_text="$2"
    cat <<EOF
{
  "jsonrpc": "2.0",
  "id": $id,
  "result": {
    "content": [
      {
        "type": "text",
        "text": "‚ùå $error_text"
      }
    ]
  }
}
EOF
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL
execute_sql() {
    local connection="$1"
    local query="$2"
    local database="$3"
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–ø—Ä–∏–≤–æ–¥–∏–º –∫ –≤–µ—Ä—Ö–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É)
    local connection_upper=$(echo "$connection" | tr '[:lower:]' '[:upper:]')
    
    local host_var="DB_${connection_upper}_HOST"
    local port_var="DB_${connection_upper}_PORT"
    local name_var="DB_${connection_upper}_NAME"
    local user_var="DB_${connection_upper}_USER"
    local pass_var="DB_${connection_upper}_PASSWORD"
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º eval –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
    local host=$(eval echo \$$host_var)
    local port=$(eval echo \$$port_var)
    local dbname=$(eval echo \$$name_var)
    local user=$(eval echo \$$user_var)
    local password=$(eval echo \$$pass_var)
    
    # –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–∞ database, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë –≤–º–µ—Å—Ç–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ .env
    if [ -n "$database" ]; then
        dbname="$database"
    fi
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ä—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    [ -z "$port" ] && port="5432"
    
    log "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ $connection: host=$host, port=$port, db=$dbname, user=$user"
    
    if [ -z "$host" ] || [ -z "$dbname" ] || [ -z "$user" ]; then
        echo "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ '$connection' –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ (–æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç host/db/user)"
        return 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–∏–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    local readonly_var="DB_${connection_upper}_READONLY"
    local readonly_mode=$(eval echo \$$readonly_var)
    
    if [ "$readonly_mode" = "true" ]; then
        if echo "$query" | grep -iq '\b\(INSERT\|UPDATE\|DELETE\|DROP\|CREATE\|ALTER\|TRUNCATE\)\b'; then
            echo "READONLY —Ä–µ–∂–∏–º –¥–ª—è $connection: —Ä–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ SELECT –∑–∞–ø—Ä–æ—Å—ã"
            return 1
        fi
    fi
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ psql –≤ —Ä–∞–∑–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
    local psql_cmd=""
    if [ -n "$PSQL_PATH" ] && [ -x "$PSQL_PATH" ]; then
        psql_cmd="$PSQL_PATH"
    elif command -v psql >/dev/null 2>&1; then
        psql_cmd="psql"
    elif [ -x "/Applications/Postgres.app/Contents/Versions/latest/bin/psql" ]; then
        psql_cmd="/Applications/Postgres.app/Contents/Versions/latest/bin/psql"
    else
        echo "psql –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ"
        return 1
    fi
    
    if [ -n "$password" ]; then
        PGPASSWORD="$password" "$psql_cmd" -h "$host" -p "$port" -U "$user" -d "$dbname" -t -A -c "$query" 2>&1
    else
        "$psql_cmd" -h "$host" -p "$port" -U "$user" -d "$dbname" -t -A -c "$query" 2>&1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
check_connection() {
    local connection="$1"
    local database="$2"  # –ù–æ–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    local result
    result=$(execute_sql "$connection" "SELECT version(), current_database(), current_user" "$database")
    
    if [ $? -eq 0 ]; then
        echo "ok"
    else
        echo "error: $result"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–¥—Å—á–µ—Ç–∞ —Å—Ç—Ä–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ
count_table_rows() {
    local connection="$1"
    local table_name="$2"
    local database="$3"
    local result
    
    # –ó–∞–ø—Ä–æ—Å –∫ —Å–∏—Å—Ç–µ–º–Ω–æ–º—É –∫–∞—Ç–∞–ª–æ–≥—É –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å—Ç—Ä–æ–∫
    local query="SELECT reltuples::bigint as estimated_rows FROM pg_catalog.pg_class WHERE relname = '$table_name'"
    result=$(execute_sql "$connection" "$query" "$database")
    
    if [ $? -eq 0 ]; then
        if [ -z "$result" ] || [ "$result" = "" ]; then
            echo "–¢–∞–±–ª–∏—Ü–∞ '$table_name' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            return 1
        else
            echo "$result"
        fi
    else
        echo "error: $result"
        return 1
    fi
}

log "MCP PostgreSQL Server started"

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
while IFS= read -r line; do
    [ -z "$line" ] && break
    
    # –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥ JSON –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è method –∏ id
    method=$(echo "$line" | sed -n 's/.*"method"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p')
    id=$(echo "$line" | sed -n 's/.*"id"[[:space:]]*:[[:space:]]*\([^,}]*\).*/\1/p')
    
    # –û—á–∏—â–∞–µ–º ID –æ—Ç –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤
    id=$(echo "$id" | sed 's/^[[:space:]]*\(.*\)[[:space:]]*$/\1/')
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø ID –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è JSON
    if [ -z "$id" ] || [ "$id" = "null" ]; then
        id="1"
        json_id="$id"
    elif echo "$id" | grep -q '^".*"$'; then
        # –°—Ç—Ä–æ–∫–æ–≤—ã–π ID - –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–≤—ã—á–∫–∏
        json_id="$id"
        id=$(echo "$id" | sed 's/^"\(.*\)"$/\1/')
    else
        # –ß–∏—Å–ª–æ–≤–æ–π ID - –±–µ–∑ –∫–∞–≤—ã—á–µ–∫, –æ—á–∏—â–∞–µ–º –æ—Ç –ø—Ä–æ–±–µ–ª–æ–≤
        json_id="$id"
    fi
    
    case "$method" in
        "initialize")
            # –û—Ç–≤–µ—Ç –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é MCP —Å–µ—Ä–≤–µ—Ä–∞
            cat <<EOF
{
  "jsonrpc": "2.0",
  "id": $json_id,
  "result": {
    "protocolVersion": "2024-11-05",
    "capabilities": {
      "tools": {}
    },
    "serverInfo": {
      "name": "mcp-postgres-bash",
      "version": "1.0.0",
      "description": "PostgreSQL MCP server –Ω–∞ bash + psql. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è, –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ SELECT –∑–∞–ø—Ä–æ—Å—ã, –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π."
    }
  }
}
EOF
            ;;
        "notifications/initialized")
            # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω - –æ—Ç–≤–µ—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
            log "Client initialized notification received"
            ;;
        "tools/list")
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            local_readonly=$(eval echo \$DB_LOCAL_READONLY)
            docker_readonly=$(eval echo \$DB_DOCKER_READONLY) 
            prod_readonly=$(eval echo \$DB_PROD_READONLY)
            
            security_desc="–†–µ–∂–∏–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: local=$([ "$local_readonly" = "true" ] && echo "READONLY" || echo "FULL"), docker=$([ "$docker_readonly" = "true" ] && echo "READONLY" || echo "FULL"), prod=$([ "$prod_readonly" = "true" ] && echo "READONLY" || echo "FULL")."
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —á–∏—Ç–∞–µ–º—ã–π JSON –æ—Ç–≤–µ—Ç —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏
            cat <<EOF
{
  "jsonrpc": "2.0",
  "id": $json_id,
  "result": {
    "tools": [
      {
        "name": "execute_sql",
        "description": "–í—ã–ø–æ–ª–Ω–∏—Ç—å SQL –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ psql. $security_desc –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∞—Ç–∏–≤–Ω—ã–π psql –∫–ª–∏–µ–Ω—Ç PostgreSQL 16.0+. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ bash –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π - –±—ã—Å—Ç—Ä–∞—è –∏ –Ω–∞–¥—ë–∂–Ω–∞—è.",
        "inputSchema": {
          "type": "object",
          "properties": {
            "connection": {
              "type": "string",
              "description": "–ò–º—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (local, docker, prod)"
            },
            "database": {
              "type": "string", 
              "description": "–ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ .env)"
            },
            "query": {
              "type": "string",
              "description": "SQL –∑–∞–ø—Ä–æ—Å (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å PostgreSQL)"
            }
          },
          "required": ["connection", "query"]
        }
      },
      {
        "name": "check_connection",
        "description": "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ PostgreSQL —Å–µ—Ä–≤–µ—Ä—É. –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞ –∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ psql.",
        "inputSchema": {
          "type": "object",
          "properties": {
            "connection": {
              "type": "string",
              "description": "–ò–º—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (local, docker, prod)"
            },
            "database": {
              "type": "string",
              "description": "–ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"
            }
          },
          "required": ["connection"]
        }
      },
      {
        "name": "count_table_rows",
        "description": "–ë—ã—Å—Ç—Ä—ã–π –ø–æ–¥—Å—á–µ—Ç —Å—Ç—Ä–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ PostgreSQL (pg_catalog.pg_class). –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ - –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –±—ã—Å—Ç—Ä–µ–µ —á–µ–º COUNT(*) –¥–ª—è –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç reltuples –¥–ª—è –æ—Ü–µ–Ω–∫–∏. –î–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–¥—Å—á–µ—Ç–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å ANALYZE table_name –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.",
        "inputSchema": {
          "type": "object",
          "properties": {
            "connection": {
              "type": "string",
              "description": "–ò–º—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (local, docker, prod)"
            },
            "table_name": {
              "type": "string",
              "description": "–ò–º—è —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —Å—Ç—Ä–æ–∫"
            },
            "database": {
              "type": "string",
              "description": "–ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"
            }
          },
          "required": ["connection", "table_name"]
        }
      }
    ]
  }
}
EOF
            ;;
        "tools/call")
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã
            tool_name=$(echo "$line" | sed -n 's/.*"name":"\([^"]*\)".*/\1/p')
            connection=$(echo "$line" | sed -n 's/.*"connection":"\([^"]*\)".*/\1/p')
            database=$(echo "$line" | sed -n 's/.*"database":"\([^"]*\)".*/\1/p')
            table_name=$(echo "$line" | sed -n 's/.*"table_name":"\([^"]*\)".*/\1/p')
            
            case "$tool_name" in
                "execute_sql")
                    query=$(echo "$line" | sed -n 's/.*"query":"\([^"]*\)".*/\1/p')
                    result=$(execute_sql "$connection" "$query" "$database")
                    if [ $? -eq 0 ]; then
                        # –£–ª—É—á—à–µ–Ω–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –¥–ª—è JSON
                        escaped_result=$(echo "$result" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed 's/\t/\\t/g' | sed 's/\r/\\r/g' | tr '\n' '|' | sed 's/|$//')
                        send_success_response "$json_id" "$escaped_result"
                    else
                        # –£–ª—É—á—à–µ–Ω–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –¥–ª—è JSON
                        escaped_error=$(echo "$result" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed 's/\t/\\t/g' | sed 's/\r/\\r/g' | tr '\n' ' ' | sed 's/  */ /g' | sed 's/^ *//' | sed 's/ *$//')
                        send_error_response "$json_id" "–û—à–∏–±–∫–∞: $escaped_error"
                    fi
                    ;;
                "check_connection")
                    result=$(check_connection "$connection" "$database")
                    if [[ "$result" == "ok" ]]; then
                        send_success_response "$json_id" "‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
                    else
                        # –£–ª—É—á—à–µ–Ω–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –¥–ª—è JSON
                        escaped_error=$(echo "$result" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed 's/\t/\\t/g' | sed 's/\r/\\r/g' | tr '\n' ' ' | sed 's/  */ /g' | sed 's/^ *//' | sed 's/ *$//')
                        send_error_response "$json_id" "$escaped_error"
                    fi
                    ;;
                "count_table_rows")
                    result=$(count_table_rows "$connection" "$table_name" "$database")
                    if [ $? -eq 0 ] && [[ ! "$result" =~ ^error: ]]; then
                        success_text="üìä –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ '$table_name': $result

üí° –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ PostgreSQL (pg_catalog.pg_class.reltuples) –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–¥—Å—á–µ—Ç–∞. –ó–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ–µ –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ VACUUM/ANALYZE.

üîß –î–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–¥—Å—á–µ—Ç–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: ANALYZE $table_name; –∑–∞—Ç–µ–º –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –∑–∞–ø—Ä–æ—Å."
                        send_success_response "$json_id" "$success_text"
                    else
                        # –£–ª—É—á—à–µ–Ω–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –¥–ª—è JSON
                        escaped_error=$(echo "$result" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed 's/\t/\\t/g' | sed 's/\r/\\r/g' | tr '\n' ' ' | sed 's/  */ /g' | sed 's/^ *//' | sed 's/ *$//')
                        send_error_response "$json_id" "$escaped_error"
                    fi
                    ;;
                *)
                    # –û—Ç–≤–µ—Ç —Å –æ—à–∏–±–∫–æ–π –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                    cat <<EOF
{
  "jsonrpc": "2.0",
  "id": $json_id,
  "error": {
    "code": -32601,
    "message": "Unknown tool: $tool_name"
  }
}
EOF
                    ;;
            esac
            ;;
        *)
            if [ -n "$method" ]; then
                # –û—Ç–≤–µ—Ç —Å –æ—à–∏–±–∫–æ–π –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞
                cat <<EOF
{
  "jsonrpc": "2.0",
  "id": $json_id,
  "error": {
    "code": -32601,
    "message": "Method not found: $method"
  }
}
EOF
            fi
            ;;
    esac
done 